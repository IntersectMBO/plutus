# This workflow sends a message to the plutus-ci channel whenever a status check.

name: "ðŸ“® Slack Message Broker"

on:
  check_run: 
    types: [completed]

jobs:
  Send:
    runs-on: [ubuntu-latest]
    steps:
      - name: Prepare Slack Message
        uses: actions/github-script@main
        id: prepare-slack-message
        with:
          script: | 
            console.log(${{ toJson(github.event) }});

            const sender = "${{ github.event.sender.login }}";
            const name = "${{ github.event.check_run.name }}";
            const status = "${{ github.event.check_run.status }}";
            const conclusion = "${{ github.event.check_run.conclusion }}";
            const url = "${{ github.event.check_run.html_url }}";

            let message = `${name} \`${conclusion}\` <${url}|View Logs> @${sender}`;
            let shouldSendMessage = conclusion == "failure";

            console.log(`message:  ${message}`);
            console.log(`shouldSendMessage:  ${shouldSendMessage}`);

            core.setOutput("message", message); 
            core.setOutput("shouldSendMessage", shouldSendMessage); 


      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.27.0
        if: ${{ steps.prepare-slack-message.outputs.shouldSendMessage == 'true' }}
        env:
            SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }} 
        with:
          channel-id: C07A1GSNZEE # plutus-ci
          payload: |
            {
              "text": "${{ steps.prepare-slack-message.outputs.message }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.prepare-slack-message.outputs.message }}" 
                  }
                }
              ]
            }



