# A nightly job which downloads script evaluation dumps from S3 and runs a regression test.
name: Script Evaluation Test
on:
  schedule:
    - cron: 30 3 * * * # 3:30am every day
  workflow_dispatch:

concurrency:
  group: script-evaluation-test
  # We only want at most one evaluation test running at a time
  cancel-in-progress: true

jobs:
  script-evaluation-test:
    runs-on: [self-hosted, plutus-benchmark]

    steps:
      - name: Checkout
        uses: actions/checkout@v3.3.0

      - name: Prepare Slack Message
        id: prepare-slack-message-1
        uses: actions/github-script@v6
        with:
          script: | 
            const jobUrl = "https://github.com/${{ github.repository }}/actions/runs/${{ github.runId }}";
            const jobName = "${{ github.job }}"
            const message = `\`${jobName}\` *started* üëâüèª <${jobUrl}|view logs>`;
            core.setOutput("message", message); 

      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: my-private-channel
          payload: |
            {
              "text": "${{ steps.prepare-slack-message-1.outputs.message }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.prepare-slack-message-1.outputs.message }}" 
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }} 

      - name: Download and Unzip Dump Files
        if: always() 
        # NOTE: the S3 location s3://plutus/mainnet-script-dump/ must match that in
        # plutus-apps/.github/script-evaluation-dump.yml
        run: |
          export LOCAL_DIR="$HOME/mainnet-script-dump-downloaded"
          nix develop --no-warn-dirty --accept-flake-config --command \
            bash ./scripts/s3-sync-unzip.sh s3://plutus/mainnet-script-dump/ \*.event.bz2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: us-east-1
          AWS_ENDPOINT_URL: https://s3.devx.iog.io

      - name: Run
        # Run the test cases sequentially. This ensures we don't need to simultaneously store
        # multiple `ScriptEvaluationEvents`, which are large, in memory. Each test case
        # contains many script evaluation events, and those are run in parallel based on
        # the number of available processors.
        run: |
          export EVENT_DUMP_DIR="$HOME/mainnet-script-dump-downloaded"
          nix run --no-warn-dirty --accept-flake-config \
            .#x86_64-linux.plutus.library.plutus-project-925.hsPkgs.plutus-ledger-api.components.exes.evaluation-test -- --num-threads=1

      - name: Prepare Slack Message
        uses: actions/github-script@v6
        id: prepare-slack-message-2
        if: always() 
        with:
          script: | 
            const jobUrl = "https://github.com/${{ github.repository }}/actions/runs/${{ github.runId }}";
            const jobName = "${{ github.job }}"
            const jobStatus = "${{ job.status }}"
            const jobStatusEmoji = { success: "‚úÖ", failure: "‚ùå", cancelled: "‚úã" }[jobStatus];
            const message = `${jobStatusEmoji} \`${jobName}\` *${jobStatus}* üëâüèª <${jobUrl}|view logs>`;
            core.setOutput("message", message); 

      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.23.0
        if: always() 
        with:
          channel-id: my-private-channel
          payload: |
            {
              "text": "${{ steps.prepare-slack-message-2.outputs.message }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.prepare-slack-message-2.outputs.message }}" 
                  }
                }
              ]
            }
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }} 