name: Benchmark
on:
  pull_request:
    types:
      - opened
      - synchronize

jobs:
  benchmark:
    runs-on: [self-hosted, plutus-benchmark]
    
    permissions:
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3.3.0

      - name: Extract Benchmark Name
        id: extract-benchmark
        uses: actions/github-script@v6
        with:
          script: |
            core.setOutput('benchmark', 'nofib');

      - name: Extract Comment Branch 
        id: extract-branch
        uses: actions/github-script@v6
        with:
          script: | 
            core.setOutput("head_ref", "bench-test");

      - name: Run
        run: |
          nix develop --no-warn-dirty --accept-flake-config --command bash ./scripts/ci-plutus-benchmark.sh 
        env:
          BENCHMARK_NAME: ${{ steps.extract-benchmark.outputs.benchmark }}
          PR_NUMBER: ${{ github.event.issue.number }}
          PR_BRANCH: ${{ steps.extract-branch.outputs.head_ref }}
