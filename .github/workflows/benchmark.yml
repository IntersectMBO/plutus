name: Benchmarking
on:
  pull_request:
  issue_comment:
    types: [created]
jobs:
  test-bench:
    runs-on: ubuntu-latest
    env:
      BUILDKITE_API_ACCESS_TOKEN: ${{ secrets.BUILDKITE_API_ACCESS_TOKEN }}
    steps:
     - run: |
         if [ -z "$BUILDKITE_API_ACCESS_TOKEN" ] ; then
            echo "[trigger-buildkite]: 'BUILDKITE_API_ACCESS_TOKEN' is not set!"
            exit 1
         fi

         if [ -z "$GITHUB_REF" ] ; then
           echo "[trigger-buildkite]: 'GITHUB_REF' is not set!"
           exit 1
         fi

         PR_BRANCH=${GITHUB_REF#refs/heads/}
         echo "[trigger-buildkite]: Triggering build for $PR_BRANCH"
         curl -H "Authorization: Bearer $BUILDKITE_API_ACCESS_TOKEN" \
              "https://api.buildkite.com/v2/organizations/input-output-hk/pipelines/plutus-benchmark/builds" \
              -X "POST" \
              -F "commit=HEAD" \
              -F "branch=$PR_BRANCH" \
              -F "message=benchmark"
     - uses: mshick/add-pr-comment@v1
       with:
         message: "Benchmarking started. Check https://buildkite.com/input-output-hk/plutus-benchmark"
         repo-token: ${{ secrets.GITHUB_TOKEN }}
         repo-token-user-login: 'github-actions[bot]'

  #bench:
    #runs-on: ubuntu-latest
    #steps:
      #- name: Check for Command
        #id: command
        #uses: xt0rted/slash-command-action@v1
        #with:
          #repo-token: ${{ secrets.GITHUB_TOKEN }}
          #command: benchmark
          #reaction: "true"
          #reaction-type: "eyes"
          #allow-edits: "true"
          #permission-level: write
      #- name: Act on the command
        #run: "curl -H \"Authorization: Bearer $BUILDKITE_API_ACCESS_TOKEN\" https://api.buildkite.com/v2/organizations/input-output-hk/pipelines/plutus-benchmark/builds -X \"POST\" -F \"commit=HEAD\" -F \"branch=${GITHUB_REF##*/}\" -F \"message=Running benchmark\""
        #
