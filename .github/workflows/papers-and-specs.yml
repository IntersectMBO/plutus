# This workflow builds and deploys various papers.
# 
# On pull requests, this workflow builds the papers and deploys a temporary preview
# to gh-pages, but only if the relevant files have changed.
#
# This workflow runs on all push to master and can also be triggered manually.
# It deploys the artifacts to: https://plutus.cardano.intersectmbo.org/resources

name: "üìù Papers & Specs"

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    paths:
      - 'doc'
      - '!doc/docusaurus/**'

jobs:
  deploy:
    name: Deploy
    runs-on: [self-hosted, plutus-ci]
    permissions:
      contents: write
    environment:
      name: github-pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4.3.0

      - name: Build Papers
        run: | 
          TARGETS=(
            plutus-report
            plutus-core-spec
            extended-utxo-spec
            unraveling-recursion-paper
            system-f-in-agda-paper
            eutxo-paper
            utxoma-paper
            eutxoma-paper
          )
          mkdir -p _resources
          for target in "${TARGETS[@]}"; do 
            nix build --no-warn-dirty --accept-flake-config .#${target}
            cp -fr ./result/*.pdf _resources/${target}.pdf
          done 

      - name: Publish Papers
        if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
        uses: JamesIves/github-pages-deploy-action@v4.7.3
        with:
          folder: _resources
          target-folder: resources
          single-commit: true

      - name: Publish Preview Papers 
        if: github.event_name == 'pull_request'
        uses: rossjrw/pr-preview-action@v1.6.2
        with:
          source-dir: _resources
          umbrella-dir: pr-preview/resources
