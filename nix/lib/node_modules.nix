{ npmlock2nix
, nodejs
, python2
, stdenv
, lib
, CoreServices ? null # needed by darwin only
, xcodebuild ? null   # needed by darwin only
}:
# Description: Takes a source directory, a `package.json` and a `package-lock.json`
# and creates an output containing `node_modules/, package.json, package-lock.json`. The `buildInputs`
# will be avaibale during `npm install`
# Type: Attr -> Derivation
{ projectDir, packageJson, packageLockJson, buildInputs ? [ ], githubSourceHashMap ? { } }:
npmlock2nix.node_modules {
  src = projectDir;
  inherit packageJson packageLockJson githubSourceHashMap;
  inherit nodejs;
  preBuild = ''
    set -x
    echo "node_modules build ..."
    echo "*****************************************************"
    cat ${nodejs}/bin/npm | head -n 20
    npm --version
    echo "*****************************************************"
  '';
  buildInputs = [ python2 ]
    ++ lib.optionals (stdenv.isDarwin) [ CoreServices xcodebuild ]
    ++ buildInputs;
}
